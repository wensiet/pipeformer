stages:
  - test
  - validate-config
  - create-compute
  - post-scripts

test-on-code-change:
  stage: test
  only:
    changes:
      - src/**/*
      - pyproject.toml
      - poetry.lock
  script:
    - echo "Barada, implement tests"


.deps-load:
  image: python:3.12
  script:
    - pip install --upgrade pip
    - pip install poetry
    - poetry install -v


validate-compute-configuration:
  extends: .deps-load
  stage: validate-config
  only:
    changes:
      - compute/**/*
  before_script:
    - source ./find_changed_config.sh
  script:
    - poetry run python cli.py validate -f $file_name -c $change_type


create-compute-instance:
  extends: .deps-load
  stage: create-compute
  only:
    changes:
      - compute/**/*
    refs:
      - main
  script:
    - poetry run python cli.py provision -f $file_name -c $change_type

apply-compute-post-scripts:
  extends: .deps-load
  stage: post-scripts
  only:
    changes:
      - compute/**/*
    refs:
      - main
  script:
    - echo "Ded, apply compute post scripts"
