stages:
  - test
  - compute

test-on-code-change:
  stage: test
  only:
    changes:
      - src/**/*
      - pyproject.toml
      - poetry.lock
  script:
    - echo "Barada, implement tests"


validate-compute-configuration:
  stage: compute
  only:
    changes:
      - compute/**/*
  image: python:3.11
  before_script:
    - apt-get update && apt-get install -y curl
    - curl -sSL https://raw.githubusercontent.com/python-poetry/poetry/master/get-poetry.py | python -
    - source $HOME/.poetry/env
  script:
    - poetry install
    - poetry run python src/main.py


create-compute-instance:
  stage: compute
  only:
    changes:
      - compute/**/*
  script:
    - echo "Ded, create compute instance"
  needs:
    - validate-compute-configuration

apply-compute-post-scripts:
  stage: compute
  only:
    changes:
      - compute/**/*
  script:
    - echo "Ded, apply compute post scripts"
  needs:
    - create-compute-instance
